//getId récupère l'ID du profil dans l'URL de la page.
function getId() {
  const _id = new URL(location.href).searchParams.get('id')
  return _id
}

//getPhotographer utilise getData pour récupérer les données du fichier JSON et retourne l'objet du profil qui correspond à l'ID fourni en argument
async function getPhotographer(id) {
  const data = await getData1()
  const photographer = data.photographers.find(function (element) {
    return element.id == id
  })
  return photographer
}

/* getMedia utilise également getData pour récupérer les données du fichier JSON et retourne
un tableau d'objets médias qui appartiennent au profil d'ID fourni en argument.*/
async function getMedia(idProfil) {
  const data = await getData1()
  const dataMedia = data.media
  let medias = dataMedia.filter(function (id) {
    return id.photographerId == idProfil
  })
  medias = medias.map(function (media) {
    if (media.hasOwnProperty('image')) {
      return creatMedia('image', media)
    }
    if (media.hasOwnProperty('video')) {
      return creatMedia('video', media)
    }
  })
  return medias
}
/* Fin de la partie qui regroupe tous les functions de récupération */

/* Partie qui regroupe tous les functions d'affichage */
function displayHeader(photographer) {
  const photographerHeader = document.querySelector('.photograph-header')
  const photographerHeaderContainer = document.createElement('div')
  photographerHeaderContainer.classList.add('photographerHeaderContainer')
  photographerHeaderContainer.setAttribute(
    'aria-label',
    'Informations sur le photographe'
  )
  photographerHeader.appendChild(photographerHeaderContainer)

  /* Je créer une "div" pour affichée les infos du photographe */
  const divHeader = document.createElement('div')
  divHeader.classList.add('divHeaderInfo')
  divHeader.setAttribute('aria-label', 'informations sur le photographe')
  photographerHeader.appendChild(divHeader)

  /* Je créer une div pour nom, pays, ville et tagline */
  const divInfo = document.createElement('div')
  divInfo.classList.add('divInfo')
  divInfo.setAttribute(
    'aria-label',
    "Contient le nom, l'emplacement et la profession du photographe"
  )
  divInfo.setAttribute('role', 'txt')
  divInfo.setAttribute('tabindex', '2')
  divHeader.appendChild(divInfo)

  const namePhotographe = document.createElement('div')
  namePhotographe.classList.add('namePhotographe')
  divInfo.appendChild(namePhotographe)

  /* Je créer H1 qui sera dans la div "divInfo" */
  const h1 = document.createElement('h1')
  h1.classList.add('photographeh1')
  h1.setAttribute('aria-label', 'Nom du photographe')
  h1.setAttribute('role', 'heading')
  h1.innerHTML = photographer.name
  namePhotographe.appendChild(h1)

  const info = document.createElement('div')
  info.classList.add('info')
  info.setAttribute('aria-label', 'info du photographe')
  info.setAttribute('tabindex', '3')
  divInfo.appendChild(info)

  /* Je créer un paragraphe pour affichée city*/
  const city = document.createElement('p')
  city.classList.add('city')
  city.setAttribute('aria-label', 'La ville du photographe')
  city.innerHTML = photographer.city + ', ' + photographer.country
  info.appendChild(city)

  /* Je créer un paragraphe pour affichée tagline*/
  const tagline = document.createElement('p')
  tagline.classList.add('tagline')
  tagline.setAttribute('aria-label', 'Citation du photographe')
  info.appendChild(tagline)
  tagline.innerHTML = photographer.tagline

  // Partie pour la photo //
  const sectionImg = document.createElement('section')
  photographerHeader.appendChild(sectionImg)

  const divImg = document.createElement('div')
  divInfo.classList.add('divImg')
  divImg.setAttribute('aria-label', 'Photo de profil du photographe')
  sectionImg.appendChild(divImg)

  const img = document.createElement('img')
  const portrait = photographer.portrait
  const picture1 = `../../assets/photographers/${portrait}`
  img.setAttribute('src', picture1)
  img.setAttribute('role', 'img')
  img.setAttribute('alt', 'Photo du photographe')
  img.setAttribute('tabindex', '5')
  img.classList.add('img')
  divImg.appendChild(img)
}

//displayMedia affiche la liste de médias sur la page web.
const displayMedia = (medias) => {
  document.querySelector('.containerBody').innerHTML = ''
  medias.forEach((element) => {
    const media = element.display()
  })
}

/* idLike a pour but de gérer le comportement de "like" sur les photos du profil. */
function gestionnaireClicLikes(medias) {
  // Récupère tous les éléments ayant la classe "imgLikes"
  const elementsLikes = document.getElementsByClassName('imgLikes')
  // Crée une référence à la liste de médias passée en paramètre
  const array = medias
  // Pour chaque élément ayant la classe "imgLikes"
  for (const elementsLike of elementsLikes) {
    // Ajoute un écouteur d'événement "click" à l'élément
    elementsLike.addEventListener('click', (e) => {
      // Récupère la valeur de l'attribut "data-id" de l'élément cliqué
      const id = e.currentTarget.dataset.id
      // Vérifie que l'attribut "data-id" existe
      if (id === undefined) {
        console.error("attribut 'data-id' manquant")
        return
      }
      // Vérifie que la valeur de l'attribut "data-id" est bien un nombre
      if (isNaN(id)) {
        console.error("attribut 'data-id' doit être un nombre")
        return
      }
      // Récupère le média correspondant à l'id
      const media = array.find((media) => {
        return media._id === Number(id)
      })
      // Vérifie si le média a été trouvé
      if (!media) {
        console.error('média introuvable')
        return
      }
      // Récupère la valeur de l'attribut "data-like" de l'élément cliqué
      let atributValue = e.currentTarget.dataset.like

      // Si l'attribut "data-like" n'existe pas, il est mis à faux par défaut
      if (atributValue === undefined) {
        atributValue = false
        e.currentTarget.dataset.like = atributValue
      }
      // Si la valeur de l'attribut "data-like" est fausse, incrémente le nombre de likes
      if (atributValue === 'false') {
        media._likes += 1
        e.currentTarget.dataset.like = true
        // Si la valeur de l'attribut "data-like" est vraie, décrémente le nombre de likes
      } else if (atributValue === 'true') {
        media._likes -= 1
        e.currentTarget.dataset.like = false
      }
      // Récupère le noeud de compte
      const countNode = e.currentTarget.parentNode.firstChild
      // Vérifie si le noeud de compte a été trouvé
      if (!countNode) {
        console.error('noeud de compte introuvable')
        return
      }
      countNode.textContent = media._likes
      // Appele la fonction "numberLikeTotal" après chaque modification du nombre de "likes"
      // pour mettre à jour le nombre total affiché sur la bar en bas de la page.
      numberLikeTotal()
    })
  }
}

// numberLikeTotal a pour but de calculer et afficher le nombre total de likes
function numberLikeTotal() {
  const elements = document.querySelectorAll('.numberLikes')
  let total = 0
  for (let i = 0; i < elements.length; i++) {
    const str = elements[i].innerHTML
    const num = parseInt(str)
    total += num
  }
  const element = document.querySelector('.txtBar')
  element.innerHTML = total
}

function displayBar(photographer) {
  const pictureIcon = `/assets/icons/heart.svg`
  const main = document.querySelector('main')
  const bar = document.createElement('div')
  bar.classList.add('bar')
  bar.setAttribute('aria-label', 'Nombre total de likes et prix par jour')
  bar.setAttribute('tabindex', '6')
  main.appendChild(bar)

  const barInfo = document.createElement('div')
  barInfo.classList.add('barLikes')
  bar.appendChild(barInfo)

  const nombre = document.createElement('div')
  nombre.classList.add('nombre')
  barInfo.appendChild(nombre)

  const txtBar = document.createElement('p')
  txtBar.classList.add('txtBar')
  nombre.appendChild(txtBar)

  const coeur = document.createElement('div')
  coeur.classList.add('coeur')
  barInfo.appendChild(coeur)

  const pictureHeart = `assets/icons/heart.svg`
  const imgHeart = document.createElement('img')
  imgHeart.setAttribute('src', pictureHeart)
  imgHeart.setAttribute('alt', 'Icon représentant un coeur')
  imgHeart.classList.add('barHeart')
  coeur.appendChild(imgHeart)

  const barPrice = document.createElement('div')
  barPrice.classList.add('barPrice')
  bar.appendChild(barPrice)

  const priceDay = document.createElement('div')
  priceDay.classList.add('priceDay')
  barPrice.appendChild(priceDay)
  priceDay.innerHTML = '300 / jours'

  // Mise à jour du prix affiché sur la page web
  const prix = document.querySelector('.priceDay')
  prix.innerHTML = photographer.price + '€ /jour'
}

async function init() {
  const photographerId = getId()
  const photographer = await getPhotographer(photographerId)
  displayHeader(photographer)
  const namePhotographeForm = document.querySelector('#nomPhotographer')
  namePhotographeForm.innerHTML = photographer.name
  const medias = await getMedia(photographerId)

  displayBar(photographer)
  gestionnaireClicLikes(medias)
  const lightbox = new Lightbox(medias)
  numberLikeTotal()
}

init()

////////

// filter crée et ajoute à la page web un formulaire de tri des médias.
function filter(medias) {
  const divContainer = document.createElement('div')
  divContainer.classList.add('container')
  main.appendChild(divContainer)

  const divContainerHeader = document.createElement('div')
  divContainerHeader.classList.add('container-header')
  divContainer.appendChild(divContainerHeader)

  const divTitreH2 = document.createElement('div')
  divTitreH2.classList.add('divTitreH2')
  divTitreH2.setAttribute('tabindex', '7')
  divContainerHeader.appendChild(divTitreH2)

  const titreH2 = document.createElement('h2')
  titreH2.classList.add('titreH2')
  titreH2.innerHTML = 'Trier par '
  titreH2.setAttribute('aria-label', 'Trier par')
  titreH2.setAttribute('role', 'heading')
  divTitreH2.appendChild(titreH2)
  /*

  const divSelect = document.createElement('div')
  divSelect.classList.add('custom-select')
  divContainerHeader.appendChild(divSelect)
  const select = document.createElement('select')
  select.setAttribute('id', 'mySelect')
  select.classList.add('select')
  select.setAttribute('tabindex', '8')
  select.setAttribute('aria-label', 'Sélecteur de tri')
  let popularite = new Option('Popularité')
  popularite.setAttribute('value', 'popularite')
  let date = new Option('Date')
  date.setAttribute('value', 'date')
  let titre = new Option('Titre')
  titre.setAttribute('value', 'titre')
  divSelect.appendChild(select)

  const selectOption = document.querySelector('select-option')
  selectOption.add(popularite)
  selectOption.add(date)
  selectOption.add(titre)
  */

  const select = document.querySelector('')

  const containerBody = document.createElement('div')
  containerBody.classList.add('containerBody')
  divContainer.appendChild(containerBody)
}

// sortMedias trie les médias selon le critère sélectionné dans le formulaire de tri.
// Elle prend en paramètre un tableau de médias.
// Elle récupère la valeur sélectionnée dans le menu déroulant du formulaire de tri, puis appelle la fonction
function sortMedias(medias) {
  let x = document.getElementById('select-first-option-text').textContent
  console.log(x)
  if (x === 'Popularité') {
    displayMedia(medias.sort(customSortLikes))
    gestionnaireClicLikes(medias)
  } else if (x === 'Date') {
    displayMedia(medias.sort(customSortDate))
    gestionnaireClicLikes(medias)
  } else if (x === 'Titre') {
    displayMedia(medias.sort(customSortTitre))
    gestionnaireClicLikes(medias)
  }
  return
}

customSortDate = (a, b) => {
  const dateA = new Date(a._date)
  const dateB = new Date(b._date)
  if (dateA > dateB) return 1
  else if (dateA < dateB) return -1
  return 0
}

customSortLikes = (a, b) => {
  const likesA = a._likes
  const likesB = b._likes
  if (likesA > likesB) return 1
  else if (likesA < likesB) return -1
  return 0
}

customSortTitre = (a, b) => {
  const titreA = a._title
  const titreB = b._title
  if (titreA > titreB) return 1
  else if (titreA < titreB) return -1
  return 0
}

function gestionSelect() {
  let isOpen = false
  const selectOptions = document.querySelector('#select-block-options')
  const firstButtonText = document.querySelector('#select-first-option-text')
  const optionsButtons = selectOptions.querySelectorAll('button')
  document
    .querySelector('#select-first-option')
    .addEventListener('click', () => {
      if (isOpen === false) {
        // On ouvre le faux select
        selectOptions.style.display = 'block'
        isOpen = true
        return handleButtonsOptions()
      }
      if (isOpen === true) {
        return closeSelect()
      }
    })

  function closeSelect() {
    // On ferme le faux select
    selectOptions.style.display = 'none'
    return (isOpen = false)
  }

  function handleButtonsOptions() {
    optionsButtons.forEach((button) => {
      button.onclick = () => {
        const buttonText = button.textContent
        button.innerHTML = firstButtonText.textContent
        firstButtonText.innerHTML = buttonText
        return closeSelect()
      }
    })
  }
}

//displayMedia affiche la liste de médias sur la page web.
const displayMedia = (medias) => {
  document.querySelector('.containerBody').innerHTML = ''
  medias.forEach((element) => {
    const media = element.display()
  })
}

async function init() {
  const photographerId = getId()
  const medias = await getMedia(photographerId)
  filter(medias)
  gestionSelect()
  console.log('ici')

  const span = document.querySelector('#select-first-option-text')
  console.log(span)
  // créer un nouvel observer
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'childList') {
        console.log('Le contenu du span a été modifié')
        // faire quelque chose ici

        sortMedias(medias)
        console.log('LOOOOL')
      }
    })
  })

  // configuration de l'observer : observer les modifications de texte dans l'élément span
  const observerConfig = { childList: true }

  // attacher l'observer à l'élément span
  observer.observe(span, observerConfig)

  //displayMedia affiche la liste de médias sur la page web.
}

init()
